name: Update Conda-Forge Recipe

on:
  release:
    types: [published]

jobs:
  update-conda-forge:
    runs-on: ubuntu-latest
    env:
      TAG_NAME: ${{ github.event.release.tag_name }}
      YAML_PATH: recipe/meta.yaml

    steps:
      - name: Checkout the feedstock
        uses: actions/checkout@v2
        with:
          repository: conda-forge/hpc-feedstock
          token: ${{ secrets.CREATE_RELEASE }}

      - name: Update recipe version and sha256
        run: |
          echo $TAG_NAME
          # Assuming a simple Python package, update the version
          sed -i "s/version = \".*\"/version = \"$TAG_NAME\"/" $YAML_PATH
          # Update the sha256 checksum (you would need to calculate this, e.g., by downloading the release source archive)
          SHA256SUM=$(wget -qO- https://github.com/Serapieum-of-alex/hpc/archive/$TAG_NAME.tar.gz | sha256sum | cut -d ' ' -f1)
          sed -i "s/sha256: .*/sha256: $SHA256SUM/" $YAML_PATH

      - name: Download requirements.txt
        run: |
          curl -sL "https://raw.githubusercontent.com/Serapieum-of-alex/hpc/$TAG_NAME/requirements.txt" -o requirements.txt
          # Prepare the requirements to be inserted into the meta.yaml
          # Prefix each line with two spaces and a dash
          formatted_requirements=$(sed 's/^/  - /' "requirements.txt")

          # Delete the existing 'requirements: run:' section from meta.yaml
          sed -i '/^requirements: run:/,/^[^ ]/d' "$YAML_PATH"

          # Use awk to append the new requirements after the 'requirements: run:' line
          awk -v req="$formatted_requirements" '
              /requirements: run:/ {
                  print $0;  # Print the line
                  print req;  # Print the new requirements
                  next;  # Skip to the next line
              }
              { print }  # Print all other lines
          ' "$YAML_PATH" > temp_meta.yaml && mv temp_meta.yaml "$YAML_PATH"

          cat $YAML_PATH

      - name: Configure Git
        run: |
          git config --global user.name 'mafarrag'
          git config --global user.email 'moah.farag@gmail.com'

      - name: Commit changes
        run: |
          git add $YAML_PATH
          git commit -m "Update to version $TAG_NAME

      - name: Push changes
        run: |
          git push

      # If you want to create a pull request to the feedstock repository
      - name: Create Pull Request
        run: |
          echo $TAG_NAME
          git checkout -b version-update-$TAG_NAME
          git push origin version-update-$TAG_NAME
          gh pr create --title "Update recipe to $TAG_NAME" --body "This PR updates the recipe to the newly released version." --head version-update-$TAG_NAME --base main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
